{% extends "base.html" %}
{% block title %}Database - JN Records{% endblock %}

{% block content %}

<div style="position: fixed; top: 10px; left: 10px; z-index: 999;">
    <a href="{{ url_for('routes.dashboard') }}"
        style="top: 15px; left: 15px; z-index: 1000;
          background-color: white;
          border: 2px solid black;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          text-decoration: none;
          color: black;"
    title="Return to Dashboard">
    <i class="fas fa-house"></i>
    </a>
  </div>

<div class="container" style="padding-top: 60px;">
    <h2>All Contracts</h2>

<form method="get" action="{{ url_for('routes.database') }}" class="row g-3 align-items-center mb-3">
    <div class="col-auto">
        <label for="sort" class="col-form-label">Sort by:</label>
    </div>
    <div class="col-auto">
        <select name="sort" id="sort" class="form-select">
      <option value="date_desc" {% if request.args.get('sort') == 'date_desc' %}selected{% endif %}>Date (Newest → Oldest)</option>
      <option value="date_asc" {% if request.args.get('sort') == 'date_asc' %}selected{% endif %}>Date (Oldest → Newest)</option>
      <option value="artist_asc" {% if request.args.get('sort') == 'artist_asc' %}selected{% endif %}>Artist (A-Z)</option>
      <option value="artist_desc" {% if request.args.get('sort') == 'artist_desc' %}selected{% endif %}>Artist (Z-A)</option>
      <option value="category_asc">Category (A–Z)</option>
      <option value="category_desc">Category (Z–A)</option>

    </select>
</div>
<div class="col-auto">
  <button type="submit" class="btn btn-dark">Apply</button>
</div>
</form>



<input type="text" id="filterInput" class="form-control mb-3" placeholder="Filter by artist, keyword, affiliation...">

<table class="table table-bordered table-striped table-hover" id="contractsTable">
    <thead class="table-dark">
        <tr>
            <th onclick="sortTable(0)">File Name ⬍</th>
            <th onclick="sortTable(1)">Artist ⬍</th>
            <th onclick="sortTable(2)">Date ⬍</th>
            <th onclick="sortTable(3)">Keywords ⬍</th>
            <th onclick="sortTable(4)">Affiliation ⬍</th>
            <th onclick="sortTable(5)">Completion ⬍</th>
            <th onclick="sortTable(6)">Category ⬍</th>
            <th>Summary</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for contract in contracts %}
        <tr>
            <td>{{ contract.display_name }}</td>
            <td>{{ contract.artist_name }}</td>
            <td>{{ contract.date }}</td>
            <td>{{ contract.keywords or '—' }}</td>
            <td>{{ contract.affiliation or '—' }}</td>
            <td>{{ contract.status or '—' }}</td>
            <td>{{ contract.category or '—' }}</td>
            <td>{{ contract.summary or '—' }}</td>
            <td class="d-flex flex-column gap-1">
                <a href="{{ url_for('routes.open_contract', filename=contract.filename) }}" target="_blank" class="btn btn-primary btn-sm">Open</a>
                <a href="{{ url_for('routes.edit_contract', id=contract.id) }}" class="btn btn-secondary btn-sm">Edit</a>
                <a href="{{ url_for('routes.contract_overview', contract_id=contract.id) }}" class="btn btn-info btn-sm">Overview</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
  // Filter
  document.getElementById("filterInput").addEventListener("keyup", function() {
    let input = this.value.toLowerCase();
    let rows = document.querySelectorAll("#contractsTable tbody tr");
    rows.forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
    });
  });

  // Sort
  function sortTable(colIndex) {
    const table = document.getElementById("contractsTable");
    let switching = true, dir = "asc", switchcount = 0;
    while (switching) {
      switching = false;
      let rows = table.rows;
      for (let i = 1; i < rows.length - 1; i++) {
        let x = rows[i].getElementsByTagName("TD")[colIndex];
        let y = rows[i + 1].getElementsByTagName("TD")[colIndex];
        let shouldSwitch = dir == "asc" 
            ? x.innerText.toLowerCase() > y.innerText.toLowerCase()
            : x.innerText.toLowerCase() < y.innerText.toLowerCase();
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchcount++;
          break;
        }
      }
      if (!switching && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
</script>
</div>
{% endblock %}
